@using MHRTalismanManager.Shared
@using System.Text.Json
@inject ILocalStorageService LocalStorage

<Field>
    <Button Type="ButtonType.Button" Color="Color.Primary" Clicked="@ExportToWikiDb" Disabled="@Disabled">Export</Button>
</Field>
<Field>
    <FieldLabel>Data</FieldLabel>
    <MemoEdit Rows="10" Text="@_mhRiseWikiDbExportString"></MemoEdit>
</Field>

@code {
    private const string TalismanDataKey = "talismans";
    private string _mhRiseWikiDbExportString = string.Empty;
    private bool _disabled;

    [Inject]
    private IApplicationInsights AppInsights { get; set; }

    [Parameter]
    public bool Disabled
    {
        get => _disabled;
        set
        {
            if (_disabled == value)
                return;
            _disabled = value;
            DisabledChanged.InvokeAsync(value);
        }
    }

    [Parameter]
    public EventCallback<bool> DisabledChanged { get; set; }

    private async void ExportToWikiDb()
    {
        if (!await LocalStorage.ContainKeyAsync(TalismanDataKey))
        {
            return;
        }

        await AppInsights.TrackEvent("MhRiseWikiDbExport");

        var talismanData = JsonSerializer.Deserialize<List<Talisman>>(await LocalStorage.GetItemAsStringAsync(TalismanDataKey));

        _mhRiseWikiDbExportString = MhRiseWikiDbSerializer.Serialize(talismanData);

        Disabled = false;

        StateHasChanged();
    }

}